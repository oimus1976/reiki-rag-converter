---
title: Table_Extractor_Phase2_CSV_Design_Brief_v0.1
project: reiki-rag-converter
component: table_extractor
phase: 2
status: draft
created: 2026-01-25
updated: 2026-01-25
depends_on:
  - Table_Extractor_Design_Brief_v0.1.md
---

# Table Extractor Phase 2: CSV Extraction Design Brief (v0.1)

## 1. 目的（Purpose）

Phase 2 では、条例の別表中に含まれる HTML `<table>` 要素を、  
**機械可読かつ再利用可能な正本データとして CSV に変換する**ことを目的とする。

本フェーズの主眼は、表に含まれる情報を意味解釈することではなく、  
**行・列・順序を失うことなく構造化データとして保存すること**にある。

Phase 1 において確立された AnnexRegion / AnnexItem / AnnexPart の構造は維持され、  
Phase 2 はそれらを前提条件として **表データのみを独立して正本化**する。

生成される CSV は、RAG 登録、評価実験、将来的な正規化処理や JSON / DB 変換の  
**基礎データ（single source of truth）**として位置づけられる。
了解。では **Phase 2（CSV 抽出）設計ブリーフ v0.1**の**章立てを“中身の方向性つき”で一緒に埋めます**。
※この段階ではコードI/F・CSV詳細までは踏み込まず、**判断の軸が残る粒度**に止めます。

---

## 2. スコープ（In Scope / Out of Scope）

本フェーズでは、別表中の表データを **正確に CSV 化すること**に集中し、  
表の意味的解釈や再構成は行わない。

### 2.1 In Scope（対象範囲）

Phase 2 において実施する処理は、以下に限定される。

- HTML 内の `<table>` 要素を入力として受け取ること
- `<table>` 内の行・列・セルの順序を保持したまま CSV に変換すること
- 表が属する別表・項目との対応関係を、メタデータとして付与すること
  - annex_no（別表番号）
  - item_no（項番号。存在しない場合は空）
  - table_no（同一 AnnexItem 内での表の出現順）
- 見出し行を含め、HTML 上に存在するすべてのセルを CSV に出力すること

これらの処理は、Phase 1 で確定した AnnexRegion / AnnexItem の構造を前提とし、  
**それらを変更・再解釈しない**。

### 2.2 Out of Scope（非対象範囲）

以下の処理は、本フェーズでは意図的に行わない。

- 金額・税率・数量等の意味解釈や正規化
- 「以上／未満」「1件につき」等の条件文の解析
- 表の内容を Markdown 表として再構成すること
- AnnexItem の再分割、統合、並び替え
- CSV の人間可読性を高めるための整形や省略

これらは Phase 3 以降、または別コンポーネントで扱うことを前提とする。

---

## 3. Phase 1 との責務分離

本コンポーネントは、Phase 1 と Phase 2 の責務を明確に分離した設計を前提とする。

- **Phase 1** は、別表を含む条例文書から  
  AnnexRegion / AnnexItem / AnnexPart を抽出し、  
  **意味構造および文脈を保持した Markdown 表現**を生成するフェーズである。

- **Phase 2** は、Phase 1 で識別された表データを対象に、  
  **表そのものを正本データとして CSV 化**するフェーズである。

### 3.1 分離原則

両フェーズの責務は、以下の原則に基づいて分離される。

- Phase 2 は Phase 1 の **処理結果や生成物（Markdown）に依存しない**
- Phase 2 は AnnexRegion / AnnexItem を **参照のみ**とし、構造の変更を行わない
- `<table>` 要素を含まない AnnexItem は、Phase 2 の処理対象外とする

この分離により、文脈保持（Phase 1）と事実データの正本化（Phase 2）が独立して進化可能となり、  
いずれかの変更が他方に影響を及ぼすことを防ぐ。

### 3.2 設計上の意図

Phase 2 が Phase 1 の出力に直接依存しない設計とすることで、

- Markdown 表現の変更
- 表示用レンダリング方針の変更
- dummy placeholder の廃止や差し替え

といった変更が、CSV 抽出ロジックに影響しない構造を確保する。

これにより、本プロジェクトにおける別表処理は  
**「意味構造の抽出」と「事実データの正本化」**という二層構造として整理される。

---

## 4. 入力データモデル（Input）

Phase 2 における入力は、Phase 1 の処理過程で検出・抽出された  
`ExtractedTable` オブジェクトとする。

### 4.1 ExtractedTable の位置づけ

`ExtractedTable` は、条例 HTML 内に存在する単一の `<table>` 要素を表すものであり、  
**表データの正本化に必要な最小限の文脈情報**を保持する。

`ExtractedTable` は AnnexItem や AnnexRegion の構造を内包するものではなく、  
それらへの参照情報を付随的に持つ。

### 4.2 保持される情報

`ExtractedTable` は、少なくとも以下の情報を保持することを前提とする。

- 元となる HTML `<table>` ノード
- 当該表が属する別表・項目を識別するための情報
  - annex_no（別表番号）
  - item_no（項番号。存在しない場合は空）
  - table_no（同一 AnnexItem 内での表の出現順）
- region 内での順序や位置を示す補助的な情報（order 等）
  - これらは CSV 出力時の再現性確保を目的とし、意味解釈には用いない

### 4.3 入力データに関する原則

- 入力は **HTML 由来の構造情報**とする
- Phase 1 で生成された Markdown は、Phase 2 の入力として使用しない
- HTML 上に存在する情報を欠落させず保持することを優先する

この原則により、表示表現や Markdown レンダリング方針の変更が  
CSV 抽出処理に影響を与えない設計とする。

---

## 5. 出力データモデル（Output：CSV v0.1）

Phase 2 の出力は、別表中の表データを正本として保持する  
**CSV ファイル群**とする。

本章では、Phase 2 における CSV 出力の基本方針および  
最小限のスキーマ定義（v0.1）を示す。

### 5.1 基本方針

CSV 出力は、以下の設計方針に基づいて生成される。

- **フラット**  
  ネスト構造や階層構造を持たせず、1セル＝1レコードの形式とする。

- **順序保持**  
  HTML `<table>` 上の行・列の出現順を保持する。  
  並び順は意味情報として扱い、再構成可能な形で保存する。

- **冗長OK（再現性優先）**  
  情報の重複や冗長さを許容し、  
  元の表構造を損なわず再現できることを最優先とする。

### 5.2 最小スキーマ（v0.1）

Phase 2 における CSV の最小スキーマは、以下のカラムで構成される。

- `annex_no`  
  表が属する別表番号

- `item_no`  
  表が属する項番号  
  （項番号が存在しない場合は空とする）

- `table_no`  
  同一 AnnexItem 内における表の出現順

- `row_no`  
  表内での行番号（1 始まり）

- `col_no`  
  表内での列番号（1 始まり）

- `value`  
  当該セルに含まれる文字列値

### 5.3 見出し行の扱い

HTML `<table>` における見出し行（`<th>` 等）は、  
特別な意味付けを行わず、通常のセルと同様に CSV に出力する。

これにより、表構造の再現性を確保し、  
後続フェーズにおいて必要に応じた解釈や変換を可能とする。

---

## 6. CSV を正本とする理由

Phase 2 において CSV を表データの正本と位置づける理由は、  
表が持つ構造的・数値的情報を **安定して再利用可能な形で保持するため**である。

### 6.1 構造的な強み

CSV は、行・列という明示的な構造を持つため、

- 列単位での比較
- 条件（以上／未満等）の評価
- 金額や数量の判定

といった処理に適している。  
これは、Markdown 表や自然言語テキストでは保証できない特性である。

### 6.2 LLM / RAG における誤解釈の低減

Markdown 表は人間にとって可読性が高い一方で、  
LLM による解釈では列対応や条件関係が曖昧になる場合がある。

CSV を正本とすることで、

- セル単位での明確な分解
- 行・列位置に基づく参照
- 再現性の高いデータ供給

が可能となり、RAG 実行時の誤解釈を抑制できる。

### 6.3 将来拡張への適合性

CSV 形式は、

- JSON への変換
- DataFrame（pandas 等）での処理
- データベース格納

といった後続処理においても無損失で展開可能である。

これにより、Phase 3 以降の正規化処理や評価基盤の拡張に対して、  
安定した基礎データとして機能する。

> Markdown 表は「読む用」、CSV は「使う用」と位置づけ、  
> 表データの正本は CSV に一本化する。

---

## 7. implicit / explicit annex との関係

Phase 2 における CSV 抽出処理は、  
AnnexRegion の決定方法（explicit / implicit）に関して **Phase 1 の判断を完全に尊重**する。

### 7.1 explicit annex の場合

HTML 上に明示的な AnnexHeading（例：「別表第1」「別表第2」）が存在する場合は、  
Phase 1 において確定された AnnexRegion に従って表データを処理する。

- AnnexHeading に対応する region を基準とする
- table_no は、同一 AnnexRegion（および AnnexItem）内での出現順に基づき付与する

### 7.2 implicit annex（fallback）の場合

AnnexHeading が存在しない場合でも、  
Phase 1 において **implicit annex region（fallback）** が生成されている場合がある。

この場合、Phase 2 では以下の方針を取る。

- implicit annex region を 1 つの AnnexRegion として扱う
- 当該 region 内で出現する `<table>` に対し、table_no を連番で付与する
- CSV 生成ロジック自体は explicit annex の場合と同一とする

### 7.3 設計上の原則

- AnnexRegion の切り方や範囲判定は Phase 2 では行わない
- implicit / explicit の違いは **抽出条件ではなく、前提条件**として扱う
- Phase 2 は、Phase 1 の決定結果を入力として受け取り、それを変更しない

この原則により、別表検出ロジックの変更や改善が  
CSV 抽出処理に影響を与えない構造を維持する。

---

## 8. 非目標（Non-goals）

Phase 2 では、表データを CSV として正本化することに集中し、  
以下の処理は **意図的に非目標**とする。

- 税率・使用料・金額等の意味的な正規化  
  （数値化、単位変換、条件評価等を含む）

- 「以上／未満」「1件につき」などの条件式や自然言語表現の解析

- CSV の人間可読性を高めるための整形や省略  
  （列名の意味付け、表題の付与、視認性向上等）

これらは、表データの**意味解釈・利用フェーズ**に属する処理であり、  
Phase 2 の責務には含めない。

本フェーズでは、元の HTML `<table>` が持つ構造と内容を  
**欠落なく・再現可能な形で保存すること**を最優先とする。

---

## 9. 将来拡張（Phase 3 以降への布石）

Phase 2 は、別表中の表データを **安定した正本データとして保持するための基盤**であり、  
本フェーズ単体で完結することを目的とはしない。

Phase 2 で生成される CSV は、Phase 3 以降において以下の拡張処理へ接続されることを想定する。

- CSV データを基にした JSON Schema の定義および構造化
- 条件式や金額表現の正規化  
  （数値化、単位整理、比較条件の明示化等）
- RAG 実行時に利用するための特徴量生成や索引設計
- 評価結果を踏まえた Golden Spec への正式採用

これらの処理は、Phase 2 の CSV を入力とすることで、  
元の HTML 構造に依存せずに実施可能となる。

Phase 2 は、後続フェーズの実装自由度と安全性を確保するための  
**拡張前提の安定基盤**として位置づけられる。

---
