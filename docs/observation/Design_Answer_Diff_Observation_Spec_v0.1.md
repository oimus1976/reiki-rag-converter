---
title: Design Answer Diff Observation
version: v0.1
status: active
scope: observation
last_updated: 2026-01-18
related:
  - Design_Answer_Diff_Observation_v0.1.md
  - Qommons_Evaluation_Framework_v0.1.md
---

## 1. Purpose（目的）

本仕様書は、HTML版および Markdown版の `answer.md` に対して、
**出力結果の差を評価に先立って観測・記録するための実装仕様**を定義することを目的とする。

本仕様で扱う「差分」は、

- 正誤
- 品質
- 妥当性
- 優劣

を直接判断するものではなく、
**評価工程に入力される前段の観測データ**として位置づけられる。

---

### 1.1 本仕様の目的

本仕様の目的は、以下に集約される。

- HTML版 / Markdown版 `answer.md` の出力差を
  **条例ID × 質問ID 単位で体系的に観測**すること
- 観測結果を、
  **評価・是非判断に先立つ中立な情報として固定**すること
- 人手による評価工程（Gate Judgment）において、
  差分確認・原文参照の負荷を軽減すること

---

### 1.2 本仕様が提供するもの

本仕様は、以下を提供する。

- 差分観測のための **共通観測軸**
- 観測結果を表現する **機械可読（JSON）／人可読（Markdown）出力仕様**
- compare_answers.py 実装を拘束する **最小かつ十分な仕様**

---

### 1.3 本仕様が提供しないもの

本仕様は、以下を提供しない。

- 差分に対する評価・採否・重要度の判断
- LLM 出力の品質評価やスコアリング
- answer.md の修正・正規化・補正
- Evaluation Framework 自体の定義・変更

これらはすべて、
**評価工程（Evaluation / Gate Judgment）の責務**であり、
本仕様のスコープ外とする。

---

### 1.4 位置づけの要点（要約）

> 本仕様は
> **「評価を行うための仕様」ではなく、
> 「評価を歪めずに行うための観測仕様」**である。

この原則は、以降の章および compare_answers.py の実装において
**常に優先される不変条件**とする。

---

## 2. Scope & Non-Scope（スコープ定義）

本章では、本仕様が **何を対象とし、何を対象としないか**を明確にする。
これは compare_answers.py の実装範囲を固定し、
評価工程との責務混線を防ぐための境界定義である。

---

### 2.1 Scope（本仕様が扱う範囲）

本仕様は、以下をスコープに含む。

- HTML版および Markdown版の `answer.md` を
  **同一条例ID × 質問ID 単位で対応付けること**
- 対応付けられた `answer.md` ペアに対し、
  以下の観点で **差分を観測すること**
  - 構造差（Structural Diff）
  - 情報量差（Volume Diff）
  - 参照表現差（Reference Diff）
- 観測結果を、以下 2 形式で出力すること
  - 機械可読形式（JSON）
  - 人可読形式（Markdown）

これらはすべて、
**評価に先立つ観測情報を安定して生成するための最小要件**である。

---

### 2.2 Non-Scope（本仕様が扱わない範囲）

本仕様は、以下を明示的にスコープ外とする。

- 差分に対する **正誤・品質・優劣の判断**
- LLM 出力に対する **評価・スコアリング・ランキング**
- `answer.md` の内容に対する修正・補正・正規化
- Evaluation Framework（Gate Judgment）の定義・変更
- 観測結果に基づく **自動判定ロジックの実装**

これらはすべて、
**観測結果を受け取った後段の評価工程の責務**であり、
本仕様および compare_answers.py の責務には含めない。

---

### 2.3 スコープ境界に関する原則（不変条件）

- 本仕様は
  **「差があるかどうか」を観測するための仕様**である
- 本仕様は
  **「その差が良いか悪いか」を決める仕様ではない**
- 観測結果は
  **評価工程を補助するための材料**であり、
  評価そのものを代替しない

この境界は、
以降の章で定義されるすべての検出ルール・出力仕様において
**常に維持されなければならない**。

---

## 3. Positioning in Evaluation Pipeline（位置づけ）

本章では、本仕様および compare_answers.py が
**評価パイプライン全体のどこに位置づけられるか**を明確にする。

本位置づけは、
実装範囲の逸脱や責務混線を防ぐための
**設計上の不変条件**として扱われる。

---

### 3.1 全体パイプラインにおける位置づけ

本仕様で定義する Answer Diff Observation は、
生成AI評価パイプラインの中で
**「評価に先立つ観測工程」**として位置づけられる。

```text
Execution Input
  └─ HTML / Markdown Knowledge
        ↓
     RAG Answer Generation
        ↓
  Answer Diff Observation   ← 本仕様（compare_answers.py）
        ↓
  Evaluation Framework
        ↓
     Human Gate Judgment
```

本仕様は、
RAG によって生成された `answer.md` を直接評価するのではなく、
**評価前に「どのような差が生じているか」を固定する工程**を担う。

---

### 3.2 Execution Input Contract との関係

Execution Input Contract は、

- 入力データの構造
- 入力データの責務範囲
- 再現性の前提条件

を規定するものである。

本仕様は、

- Execution Input Contract に基づいて生成された
  `answer.md` を入力として受け取る
- その内容・形式・生成条件に
  **一切の変更を加えない**

という前提に立つ。

すなわち、本仕様は：

- Execution Input Contract を **拡張しない**
- Execution Input Contract を **修正しない**
- Execution Input Contract の妥当性を **検証しない**

Execution Input Contract が守られていることを前提として、
**その結果として生じた出力差のみを観測対象**とする。

---

### 3.3 Evaluation Framework との責務分離

Evaluation Framework（Gate Judgment）は、

- 観測結果
- answer.md 原文
- 質問設計意図
- その他の評価補助情報

を総合して、
**人手による評価判断を行う工程**である。

これに対し、本仕様は：

- 差分の検出
- 差分の定量化
- 差分の整理・要約

までを責務とし、
**評価判断そのものには踏み込まない**。

この責務分離により：

- 観測ロジックの変更が
  評価基準に直接影響することを防ぐ
- 評価基準の見直しが
  観測スクリプトの修正を必要としない

という、
**長期運用に耐える分離構造**を実現する。

---

### 3.4 「観測」で止める理由

本仕様が「観測」で止まり、
評価・判定まで踏み込まない理由は以下のとおりである。

1. **差分の意味は文脈依存である**
   - 同じ構造差でも、質問意図によって評価は変わる
2. **自動判定は評価の前提を固定してしまう**
   - 将来の評価基準変更に耐えられない
3. **人手評価の透明性を保つため**
   - 何が観測事実で、何が判断かを分離できる

本仕様は、

> 「差があった」という事実を
> **歪めず・過不足なく提示する**

ことに徹し、
その先の判断を人手評価工程に委ねる。

---

### 3.5 本章の要点（まとめ）

- 本仕様は
  **評価パイプラインにおける前処理工程**である
- Execution Input Contract を前提とし、
  それに手を加えない
- Evaluation Framework とは
  **責務を明確に分離**する
- 観測結果は
  **評価判断の材料であって、結論ではない**

これらの前提は、
以降の章で定義される
すべての検出ルール・出力仕様において
**不変条件として適用される**。

---

## 4. Observation Model（観測モデル）

本章では、本仕様における観測対象の単位と、
compare_answers.py が内部で扱う論理モデル（データ構造）を定義する。

本仕様は、入力として **zip に格納された成果物一式**を受け取ることを前提とする。
ただし、観測対象はその中の `answer.md` に限定され、
同梱されうる `*.json` や `*.png` 等のデバッグ補助ファイルは
観測ロジック上は参照しない（無視する）。

---

### 4.1 観測単位（Observation Unit）

観測は、以下 4 要素で一意に定まる単位で行う。

- `ordinance_id`
- `question_id`
- HTML版 `answer.md`
- Markdown版 `answer.md`

ここでいう HTML版 / Markdown版とは、
Execution Input として投入された知識表現（HTML / Markdown）の違いに対応する
**生成結果の系統差**である。

#### 4.1.1 観測単位の主キー

観測単位の主キーは以下とする。

- `(ordinance_id, question_id)`

compare_answers.py は、
同一主キーを持つ HTML版 / Markdown版の `answer.md` を **1組（ペア）として対応付け**、
そのペアに対して観測処理を行う。

#### 4.1.2 zip 前提の入力モデル（概念）

入力は zip で与えられることを前提とするため、
実装上は次の2方式を許容する。

- zip を事前に展開したディレクトリを入力として与える
- zip を入力として与え、スクリプトが内部で走査する

ただし、どちらの場合も compare_answers.py が扱う論理構造は同じであり、
zip であることは **入力の媒体差**であって
観測モデルそのものを変えない。

（zip の取り扱い方は CLI I/F 章で確定する）

---

### 4.2 内部論理モデル（Internal Logical Model）

compare_answers.py は、観測を以下 2 つの内部論理モデルで表現する。

- `AnswerPair`（観測対象ペア）
- `ObservationResult`（観測結果）

この2モデルは、観測工程の責務境界を保つために分離される。

- AnswerPair：入力（対象）の表現
- ObservationResult：観測（結果）の表現

---

#### 4.2.1 AnswerPair（観測対象ペア）

AnswerPair は、同一 `(ordinance_id, question_id)` に対する
HTML版 / Markdown版 `answer.md` のペアを表す。

```text
AnswerPair
├─ ordinance_id: str
├─ question_id: str
├─ html_answer: str   （answer.md 本文）
└─ md_answer: str     （answer.md 本文）
```

**重要な原則：**

- AnswerPair は「どちらが正しいか」を含意しない
  （html/md はあくまで入力表現差の識別子）
- AnswerPair 構築時に内容の正規化や修正を行わない
- ペアが成立しない場合（片側欠落）は、原則として観測対象外とする
  （欠落の扱いは I/F・運用章で定める）

---

#### 4.2.2 ObservationResult（観測結果）

ObservationResult は、AnswerPair に対して行った観測の結果を表す。

```text
ObservationResult
├─ ordinance_id: str
├─ question_id: str
├─ diff_flags: dict
├─ metrics: dict
└─ details: dict
```

ObservationResult は以下の性質を持つ。

- **観測事実のみ**を格納する
- 評価（OK/NG/△）や重要度判断を含めない
- 機械可読情報（diff_flags / metrics）と
  人手補助情報（details）を分離する

ObservationResult の JSON スキーマ（正本）は
次章以降で確定する。

---

### 4.3 モデル分離の理由（設計意図）

AnswerPair と ObservationResult を分離することで、以下を保証する。

- 観測ロジックが入力構造に引きずられない
  （zip/ディレクトリ/付随ファイル差を吸収できる）
- 観測結果が評価判断を含まない
  （責務混線の防止）
- v0.2 以降の拡張が「結果側」に閉じる
  （入力の扱いを不用意に変えない）

---

## 5. ObservationResult JSON Schema（v0.1）

本章では、Answer Diff Observation の結果を表現する
**JSON 出力の正本スキーマ**を定義する。

本スキーマは、

- compare_answers.py の出力仕様を拘束し
- 後段の評価工程・集計処理・再実行において
  **安定した機械処理を可能にする**

ことを目的とする。

---

### 5.1 ルート構造（集約形式）

観測結果は、以下のルート構造を持つ JSON として出力される。

```json
{
  "schema_version": "0.1",
  "generated_at": "2026-01-18T12:34:56Z",
  "observations": [
    { /* ObservationResult */ }
  ]
}
```

#### フィールド定義

| フィールド名 | 型 | 必須 | 説明 |
| -------------- | --------------- | --- | ---------------------------- |
| schema_version | string | yes | ObservationResult スキーマのバージョン |
| generated_at | string（ISO8601） | yes | 観測結果生成時刻 |
| observations | array | yes | ObservationResult の配列（0件以上） |

#### 仕様上の注意

- `observations` は **必ず配列**とする
  （観測件数が 1 件でも配列にする）
- 並び順は
  `(ordinance_id, question_id)` の昇順で **決定的**に出力する

---

### 5.2 ObservationResult 定義（1 観測単位）

ObservationResult は、
1 つの `(ordinance_id, question_id)` に対応する
HTML版 / Markdown版 answer.md の観測結果を表す。

```json
{
  "ordinance_id": "k518RG00000022",
  "question_id": "GQPA_v1_1_Q1",
  "diff_flags": { ... },
  "metrics": { ... },
  "details": { ... }
}
```

---

#### 5.2.1 識別子フィールド

| フィールド名 | 型 | 必須 | 説明 |
| ------------ | ------ | --- | ---- |
| ordinance_id | string | yes | 条例ID |
| question_id | string | yes | 質問ID |

- ObservationResult の主キーは
  `(ordinance_id, question_id)` とする
- 同一主キーを持つ ObservationResult は
  1 出力内に **複数存在してはならない**

---

#### 5.2.2 diff_flags（差分検出フラグ）

```json
"diff_flags": {
  "structural_diff": true,
  "volume_diff": false,
  "reference_diff": true
}
```

| フィールド名 | 型 | 必須 | 説明 |
| --------------- | ------- | --- | ----------- |
| structural_diff | boolean | yes | 構造差が検出されたか |
| volume_diff | boolean | yes | 情報量差が検出されたか |
| reference_diff | boolean | yes | 参照差が検出されたか |

**重要な不変条件：**

- `true` / `false` は
  **差が検出されたか否かという事実のみ**を表す
- 差分の重要度・良否・評価は含めない
- フラグの組み合わせによる解釈は行わない

---

#### 5.2.3 metrics（定量情報）

```json
"metrics": {
  "html": {
    "chars": 1044,
    "lines": 22,
    "paragraphs": 7
  },
  "markdown": {
    "chars": 1231,
    "lines": 27,
    "paragraphs": 9
  }
}
```

| フィールド名 | 型 | 必須 | 説明 |
| ---------------- | ------ | --- | ------------------------- |
| metrics.html | object | yes | HTML版 answer.md の定量情報 |
| metrics.markdown | object | yes | Markdown版 answer.md の定量情報 |

各オブジェクトは以下のキーを持つ。

| キー | 型 | 説明 |
| ---------- | ------- | --- |
| chars | integer | 文字数 |
| lines | integer | 行数 |
| paragraphs | integer | 段落数 |

---

#### 5.2.4 details（人手レビュー補助情報）

```json
"details": {
  "structural": {
    "summary": "章立て・列挙構造に差あり",
    "notes": [
      "Markdown版は見出し数が多い",
      "HTML版には箇条書きが存在しない"
    ]
  },
  "reference": {
    "summary": "条文参照は一致",
    "detected": {
      "articles": ["第1条"],
      "paragraphs": [],
      "supplementary": false
    }
  }
}
```

`details` は、
**人手評価工程における差分把握を補助するための情報**であり、
機械的な判定・集計ロジックには使用しない。

- `summary`：差分の一文要約（中立表現）
- `notes`：事実補足（任意）
- 構造・参照以外のキーは v0.1 では定義しない

---

### 5.3 禁止事項（評価語彙の排除）

ObservationResult JSON には、
以下の情報を **含めてはならない**。

- OK / NG / △ 等の評価結果
- score / rating / severity 等の数値評価
- recommendation / fix / improve 等の指示語
- correct / incorrect 等の正誤判断語彙
- Gate 判定結果やそれに準ずる情報

これらはすべて
**Evaluation Framework（評価工程）の責務**であり、
本仕様および compare_answers.py のスコープ外とする。

---

### 5.4 本章の要点（まとめ）

- ObservationResult JSON は
  **観測結果の唯一の正本表現**である
- 機械処理用情報と人手補助情報を明確に分離する
- 評価語彙を物理的に排除することで、
  観測と評価の責務境界を保証する

---

## 6. Observation Axes（観測軸）

本章では、Answer Diff Observation において
**どの観点で差分を観測するか**を定義する。

各観測軸は、

- 互いに独立しており
- 単独でも意味を持ち
- 評価判断を含まない

という性質を持つ。

compare_answers.py は、
以下で定義するすべての観測軸について
**同一の AnswerPair に対して並列に観測を行う**。

---

### 6.1 Structural Diff（構造差）

Structural Diff は、
回答の**整理単位・表現形式の違い**を観測する軸である。

ここでいう「構造」とは、
文章の意味構造や論理構成ではなく、
**表現上の区切りや並び方**を指す。

v0.1 では、以下の構造要素のみを対象とする。

- 見出し
  - 回答が章立てされているか
  - 見出しの数・階層が異なるか
- 箇条書き
  - 列挙構造が用いられているか
  - 列挙の量や有無に差があるか
- 附則セクション
  - 附則が独立したセクションとして扱われているか

Structural Diff は、
**「構造が違うと言えるかどうか」**のみを判定し、
その違いが適切か否かは扱わない。

---

### 6.2 Volume Diff（情報量差）

Volume Diff は、
回答に含まれる情報量の**物理的な差**を観測する軸である。

v0.1 では、以下の定量指標を用いる。

- `chars`
  - 文字数
- `lines`
  - 行数
- `paragraphs`
  - 段落数

これらの指標は、

- 数えるだけ
- 正規化・補正を行わない
- 閾値や増減の良否を判断しない

という原則に従って扱われる。

Volume Diff は、
**「量が変わったかどうか」**を示すものであり、
簡潔さ・冗長さ・網羅性といった評価概念とは切り離される。

---

### 6.3 Reference Diff（参照差）

Reference Diff は、
回答内に明示的に現れる**法令参照表現の差**を観測する軸である。

v0.1 では、以下の参照表現のみを対象とする。

- 第○条
- 第○項
- 附則・経過措置

Reference Diff は、

- 文字列として出現した参照のみを検出する
- 暗黙参照や文脈依存の推測は行わない
- 参照の正確性や妥当性は判断しない

という前提で設計されている。

---

### 6.4 観測軸間の関係

各観測軸は、
以下の点で明確に分離されている。

- Structural Diff
  → 表現形式・整理単位の違い
- Volume Diff
  → 情報量の物理的差
- Reference Diff
  → 明示的参照表現の差

1 つの観測軸で差分が検出された場合でも、
他の観測軸の結果に影響を与えることはない。

compare_answers.py は、
これらの観測軸を**合成せず、並置したまま出力**する。

---

### 6.5 本章の要点（まとめ）

- 観測軸は 3 種類に限定する（v0.1）
- 各軸は独立して差分を観測する
- 観測結果は評価判断を含まない
- 詳細な検出ルールは、次章以降で個別に定義する

---

## 7. Reference Diff Specification（正規表現仕様）

本章では、Reference Diff（参照差）を検出するための
**前処理ルール・正規表現・差分判定方法**を定義する。

Reference Diff の目的は、
回答内に **明示的に出現した参照表現の有無と差**を観測することであり、
参照の正確性・妥当性・解釈は一切扱わない。

---

### 7.1 前処理ルール

正規表現による検出に先立ち、
以下の前処理のみを行う。

- Unicode 正規化（NFKC）を適用する
  - 全角／半角数字の揺れを吸収するため
- 改行は保持する
- HTML / Markdown 記法の解釈は行わない
- 文脈補完・省略表現の展開は行わない

これら以外の正規化や変換は、
**参照表現を歪める可能性があるため禁止**する。

---

### 7.2 Article（第○条）

#### 7.2.1 対象例

以下のような表現を対象とする。

- 第1条
- 第１２条
- 第3条の2
- 第十条

※ 漢数字・算用数字のいずれも対象とする。

---

#### 7.2.2 正規表現

Python 実装を想定した正規表現を以下に示す。

```python
ARTICLE_PATTERN = r"第\s*([0-9０-９]+|[一二三四五六七八九十百千]+)\s*条(?:\s*の\s*[0-9０-９]+)?"
```

---

#### 7.2.3 検出ルール

- 行内に上記パターンが **1 回以上出現**した場合、検出されたとみなす
- 検出結果は、**出現した文字列そのもの**を保持する
- 重複は除去し、出力時にソートする
- 条番号の意味的解釈（順序・存在確認）は行わない

---

### 7.3 Paragraph（第○項）

#### 7.3.1 対象例

以下のような表現を対象とする。

- 第1項
- 第２項
- 第十項

---

#### 7.3.2 正規表現

```python
PARAGRAPH_PATTERN = r"第\s*([0-9０-９]+|[一二三四五六七八九十百千]+)\s*項"
```

---

#### 7.3.3 検出ルール

- 条との対応関係は考慮しない
- 単独で出現した場合も検出対象とする
- 「前項」「次項」等の指示語は対象外とする
- 重複は除去し、出力時にソートする

---

### 7.4 Supplementary（附則・経過措置）

#### 7.4.1 対象例

以下のような表現を対象とする。

- 附則
- 附　則
- 附則（令和○年○月○日施行）
- 経過措置

---

#### 7.4.2 正規表現

```python
SUPPLEMENTARY_PATTERN = r"(附\s*則|経\s*過\s*措\s*置)"
```

---

#### 7.4.3 検出ルール

- 出現の有無のみを判定する
- 見出し・本文の別は区別しない
- 個数は数えない（boolean として扱う）

---

### 7.5 差分判定ルール

Reference Diff における差分判定は、
HTML版 / Markdown版の検出結果を **集合として比較**することで行う。

#### 7.5.1 比較単位

- `articles`（第○条の集合）
- `paragraphs`（第○項の集合）
- `supplementary`（true / false）

---

#### 7.5.2 差分判定条件

以下のいずれかに該当する場合、
`reference_diff = true` とする。

- `articles` の内容が一致しない
- `paragraphs` の内容が一致しない
- `supplementary` の値が一致しない

順序差は無視し、
**集合として一致するか否かのみ**を判定する。

---

### 7.6 本章の要点（まとめ）

- Reference Diff は **文字列として現れた参照のみ**を対象とする
- 正規表現は保守的に設計し、意味解釈を行わない
- 差分判定は集合比較によって機械的に行う
- 評価・正誤判断は一切含めない

---

## 8. Volume Diff Specification（段落定義）

本章では、Volume Diff（情報量差）において用いる
**段落（paragraphs）の定義およびカウント方法**を明確にする。

Volume Diff は、
文章の意味や内容を解釈せず、
**物理的な量の差のみを観測する軸**である。

---

### 8.1 段落の定義

本仕様における「段落」とは、
**1 行以上の連続した非空行のまとまり**を指す。

より厳密には、以下を段落と定義する。

- 空行（空文字または空白のみの行）で区切られた
  **テキストブロック**
- Markdown / HTML 記法の種類は考慮しない
- 見出し行・箇条書き行・本文行はすべて同列に扱う

#### 段落定義の例

```text
第1条（目的）
この条例は〜。

第2条（定義）
この条例において〜。
```

上記は、**2 段落**として数える。

---

### 8.2 実装ルール

段落カウントは、以下の手順で行う。

1. 入力テキストを改行で分割する
2. 各行について、前後の空白を除去する
3. 空行を区切りとして、連続する非空行をグループ化する
4. グループ数を段落数とする

**重要な原則：**

- Markdown / HTML の構文解析は行わない
- `<p>` や `<br>` 等の HTML タグは解釈しない
- 視覚的な段落や意味的段落は考慮しない

---

### 8.3 カウント対象・非対象

#### 8.3.1 カウント対象

以下はすべて段落カウントの対象とする。

- 見出し行（`# 見出し` 等）
- 箇条書き行（`-`, `*`, `1.` 等）
- 本文行
- 附則・経過措置に関する記述

#### 8.3.2 カウント非対象

以下は、段落カウントの対象外とする。

- 完全に空のファイル（段落数 0）
- 空白文字のみで構成された行
- ファイル末尾の余分な改行

※ ただし、**非対象行が段落を区切る役割は持つ**。

---

### 8.4 擬似コード

段落数算出の擬似コードを以下に示す。

```python
def count_paragraphs(text: str) -> int:
    lines = text.splitlines()
    paragraphs = []
    current = []

    for line in lines:
        if line.strip() == "":
            if current:
                paragraphs.append(current)
                current = []
        else:
            current.append(line)

    if current:
        paragraphs.append(current)

    return len(paragraphs)
```

この擬似コードは、

- PoC
- 本番実装
- CI 実行

のすべてで **同一の結果を返すこと**を前提とする。

---

### 8.5 本章の要点（まとめ）

- 段落は「空行で区切られた非空行のまとまり」と定義する
- 構文解釈・意味解釈は一切行わない
- 数え方は単純・決定的であることを最優先とする
- この定義は v0.1 における **不変条件**とする

---

了解。
では **Spec 文書としての第9章**を、
「v0.1 でやらないことが明確になる」粒度で書き下ろします。

---

## 9. Structural Diff Specification（最小検出ルール v0.1）

本章では、Structural Diff（構造差）について、
**v0.1 における最小限の検出ルール**を定義する。

ここで定義されるルールは、

- 過剰な構文解析を行わず
- HTML / Markdown 双方で安定して適用でき
- 差分の有無を決定的に判定できる

ことを優先して設計されている。

---

### 9.1 対象構造要素

v0.1 では、以下の構造要素のみを対象とする。

| 構造要素 | 観測対象 | 備考 |
| ------- | ----- | ---------- |
| 見出し | 有無・個数 | 階層は考慮しない |
| 箇条書き | 有無・個数 | ネストは考慮しない |
| 附則セクション | 有無 | 独立セクションか否か |

これ以外の構造（表・引用・注釈等）は
**v0.1 では一切扱わない**。

---

### 9.2 見出し検出ルール

#### 9.2.1 検出対象

以下の行を「見出し」として検出する。

- Markdown 記法による見出し

  - `# 見出し`
  - `## 見出し` 等
- 「第○条」「附則」等、
  行頭に現れる章立て的表現

#### 9.2.2 検出方法（簡易）

- 行頭に以下のいずれかが出現した場合、見出しとみなす

  - `#`
  - `第` + 数字 or 漢数字
  - `附則`

#### 9.2.3 非対象

- 文中に出現する「第○条」
- 箇条書き内の章番号的表現
- HTML タグに基づく見出し解釈

---

### 9.3 箇条書き検出ルール

#### 9.3.1 検出対象

以下の行を「箇条書き」として検出する。

- Markdown 記法の箇条書き
  - `-`
  - `*`
  - `+`
  - `1.` `2.` 等

#### 9.3.2 検出方法

- 行頭の記号・番号により判定する
- ネストの深さは考慮しない
- 連続性や論理関係は扱わない

#### 9.3.3 非対象

- 文中の列挙表現
- 記号が行頭以外に出現する場合

---

### 9.4 附則セクション検出ルール

#### 9.4.1 検出対象

以下を附則セクションの存在とみなす。

- 行頭に「附則」が現れる行
- 「附則」という語が
  見出し相当として独立して現れる場合

#### 9.4.2 検出方法

- 1 回でも検出された場合、
  附則セクションが存在すると判定する
- 附則の内容量や内部構造は扱わない

---

### 9.5 structural_diff 判定ロジック

Structural Diff の差分判定は、
HTML版 / Markdown版それぞれについて以下を算出し、
結果を比較することで行う。

#### 9.5.1 抽出指標

- 見出し行数
- 箇条書き行数
- 附則セクション有無（boolean）

#### 9.5.2 判定条件

以下のいずれかに該当する場合、
`structural_diff = true` とする。

- 見出し行数が一致しない
- 箇条書き行数が一致しない
- 附則セクション有無が一致しない

差分の大小・意味は考慮せず、
**一致するか否かのみ**を判定する。

---

### 9.6 本章の要点（まとめ）

- Structural Diff v0.1 は **最小検出に限定**する
- 構文解析・意味解析は行わない
- 差分の有無を決定的に判定できることを優先する
- 拡張は v0.2 以降で段階的に行う

---

了解。
では **Spec 文書としての第10章**を、
「PoCで作ったものがそのまま本番に昇格できる」ことを最優先に書き下ろします。

---

## 10. compare_answers.py Responsibility & I/F

本章では、本仕様を実装に接続するために、
`compare_answers.py` の責務および外部インターフェース（I/F）を定義する。

本章で定義される内容は、
PoC・本番・CI のすべてにおいて **不変条件**として扱われる。

---

### 10.1 スクリプト責務

`compare_answers.py` の責務は、以下に限定される。

- HTML版 / Markdown版の `answer.md` を
  `(ordinance_id, question_id)` 単位で対応付けること
- 各 AnswerPair に対して、
  本仕様で定義された観測軸に基づき差分を観測すること
- 観測結果を
  ObservationResult JSON Schema（v0.1）に従って出力すること

#### 明示的に行わないこと

`compare_answers.py` は、以下を行ってはならない。

- 差分に対する評価・判定・重要度付け
- answer.md の修正・補正・正規化
- LLM 出力の品質評価・スコアリング
- 観測結果に基づく自動判定ロジックの実装

これらはすべて、
**評価工程（Evaluation Framework）の責務**である。

---

### 10.2 CLI I/F

`compare_answers.py` は、
コマンドラインインターフェース（CLI）として実行される。

#### 10.2.1 基本形式（例）

```bash
python compare_answers.py \
  --html-input <path> \
  --markdown-input <path> \
  --output <path>
```

#### 10.2.2 引数定義

| 引数 | 必須 | 説明 |
| ---------------- | --- | ---------------------------------------- |
| --html-input | yes | HTML版 answer.md 群（zip または展開済みディレクトリ） |
| --markdown-input | yes | Markdown版 answer.md 群（zip または展開済みディレクトリ） |
| --output | yes | 観測結果出力先ディレクトリ |

#### 10.2.3 入力形式に関する方針

- `--html-input` / `--markdown-input` は
  以下のいずれかを受け付ける
  - zip ファイル
  - zip を展開したディレクトリ
- zip / ディレクトリの違いは
  **スクリプト内部で吸収**する
- 呼び出し側は
  PoC / 本番で同一の I/F を使用できる

---

### 10.3 入出力ディレクトリ仕様

#### 10.3.1 入力ディレクトリ（概念）

入力は、以下の構造を持つものとする。

```text
<root>
└─ <ordinance_id>/
   └─ <question_id>/
      └─ answer.md
```

- `answer.md` 以外のファイル（json / png 等）は無視する
- ディレクトリ階層は、
  `(ordinance_id, question_id)` を一意に識別できればよい
- 階層の深さや補助ファイルの有無に依存しない実装とする

#### 10.3.2 出力ディレクトリ

出力は、以下の形式で行う。

```text
<output>/
├─ observation_result.json
└─ observation_summary.md
```

- `observation_result.json`
  - ObservationResult JSON Schema（v0.1）に準拠
- `observation_summary.md`
  - 人手評価用の差分要約
  - 評価判断は含めない

---

### 10.4 PoC / 本番の不変条件

PoC 実装と本番運用の間で、
以下の条件は **必ず不変**とする。

- 観測軸の定義（Structural / Volume / Reference）
- ObservationResult JSON Schema
- CLI 引数の意味と構造
- 入出力の論理モデル（AnswerPair / ObservationResult）

これにより：

- PoC で得られた結果は
  そのまま本番データとして扱える
- PoC 用コードの破棄・書き直しを不要にする
- テストと本番で挙動が変わるリスクを排除する

---

### 10.5 本章の要点（まとめ）

- compare_answers.py は
  **観測専用スクリプト**である
- CLI I/F は PoC / 本番共通とする
- zip / ディレクトリ差は内部で吸収する
- 観測仕様と実装を 1 対 1 で拘束する

---

## 11. Automation Policy（自動化方針）

本章では、Answer Diff Observation における
**自動化の範囲と制約**を定義する。

本方針は、compare_answers.py の実装方針だけでなく、
将来の拡張や運用判断においても **不変条件**として扱われる。

---

### 11.1 自動化の対象範囲

本仕様に基づく自動化は、
以下の工程までに限定される。

- answer.md の対応付け
- Structural / Volume / Reference 各観測軸による差分検出
- ObservationResult の生成および出力

すなわち、自動化の目的は
**「差があるかどうかを機械的に固定すること」**にある。

---

### 11.2 自動化の対象外

以下は、自動化の対象外とする。

- 差分に対する評価・是非判断
- 差分の重要度付けや優先度付け
- Gate 判定の自動化
- 観測結果に基づく意思決定

これらを自動化することは、
評価工程の前提条件を固定してしまうため、
本仕様では明確に禁止する。

---

### 11.3 LLM 利用方針

LLM の利用は、以下の条件を満たす場合に限り許容する。

- 観測結果の **要約補助**
- 人手評価の **負荷軽減**を目的とした補助処理
- 観測結果（事実）を変更・解釈しない利用

LLM は、

- 差分の有無を決定する主体
- 評価・判定を行う主体

にはならない。

---

### 11.4 本章の要点（まとめ）

- 自動化は「観測」で止める
- 判定ロジックは一切含めない
- LLM は補助的手段としてのみ利用する

これらの方針は、
Spec v0.1 における **強制ルール**であり、
例外を設けない。

---

## 12. Risk & Anti-Patterns（注意点）

本章では、Answer Diff Observation を運用する際に
特に注意すべきリスクおよびアンチパターンを整理する。

ここで挙げる事項は、
仕様・実装が正しくても **運用で破綻しうる点**であり、
設計段階で明示しておく必要がある。

---

### 12.1 差分＝不具合と誤認するリスク

最も頻発しやすい誤解は、

> 「差分がある ＝ どちらかが不具合である」

と短絡的に結論づけてしまうことである。

本仕様における差分は、

- 入力表現差（HTML / Markdown）
- 生成過程における表現揺れ

の結果として生じた **観測事実**であり、
それ自体に良否の意味は含まれない。

差分を検出した時点で
修正・是正・仕様変更に直結させることは、
本仕様の設計思想に反する。

---

### 12.2 観測と評価の混線

観測工程と評価工程が混線すると、
以下の問題が発生する。

- 観測結果に評価語彙が混入する
- 観測ロジックの変更が評価結果を歪める
- 評価基準の見直しが観測スクリプトの修正を要求する

特に、

- ObservationResult に評価的コメントを書く
- structural_diff / volume_diff を重要度として扱う

といった運用は、
**仕様違反のアンチパターン**である。

---

### 12.3 diff 全文貼りによるレビュー破綻

差分を確認する手段として、

- raw diff の全文を貼り付ける
- 行単位差分をそのままレビューに回す

といった運用は、
人手評価の負荷を著しく高める。

本仕様では、

- 差分の有無
- 差分の種類
- 要点の要約

までを観測工程で固定し、
**全文比較は必要な場合にのみ原文を参照する**
という運用を前提とする。

diff 全文貼りは、
本仕様が解決しようとしている問題そのものであり、
避けるべきアンチパターンである。

---

### 12.4 本章の要点（まとめ）

- 差分は不具合を意味しない
- 観測と評価の責務は厳密に分離する
- 人が読めない差分提示は失敗である

これらを守ることで、
Answer Diff Observation は
**評価を支える道具**として機能する。

---

## 13. Versioning Policy

本章では、本仕様書（Design_Answer_Diff_Observation_Spec）の
**バージョニング方針**を定義する。

本仕様は、運用の成熟度に応じて段階的に拡張されることを前提とするが、
既存の観測結果の解釈や再現性を損なわないよう、
**後方互換性を強く意識したバージョニング**を行う。

---

### v0.1（初期固定版）

- 観測軸（Structural / Volume / Reference）を確定する
- 観測と評価の責務境界を固定する
- compare_answers.py の基本 I/F と JSON Schema を拘束する

v0.1 は、

- 観測仕様の思想
- 実装の最小単位
- PoC と本番を接続する基準点

として扱い、
**軽微な表現修正を除き、破壊的変更は行わない**。

---

### v0.2（拡張版）

- 観測対象となる構造要素の拡張
  （例：表、別表、注記ブロック等）
- Reference Diff の拡張
  （例：号、別表参照の追加）
- details フィールドの補助情報拡充

v0.2 では、

- v0.1 の JSON Schema を破壊しない
- 既存キーの意味を変更しない
- 追加は原則としてオプショナル項目に限定する

---

### v1.0（凍結版）

- 実運用で十分な観測実績が得られた段階で凍結判断を行う
- 観測軸・JSON Schema・I/F を原則固定とする
- 以降は運用改善・周辺ツール整備を中心とする

v1.0 は、
**長期保存・再評価・再現実験に耐える安定版**として位置づける。

---

### 本章の要点（まとめ）

- v0.1 は思想と責務境界の固定点
- v0.2 は後方互換を保った拡張
- v1.0 は運用安定後の凍結版

---

## 14. Appendix（将来拡張メモ）

本章は、
本仕様のスコープ外だが将来的に検討価値のある拡張案を
**設計メモとして記録する**ものである。

ここに記載された内容は、
**現時点では実装・仕様の拘束力を持たない**。

---

### 14.1 Playwright 実行結果との突合

- RAG 実行時の UI 操作ログ
- submit 成否・待機状態
- 実行エラー有無

などと ObservationResult を突合することで、
**生成過程と出力差分の関係性**を分析できる可能性がある。

---

### 14.2 Gate NG ケースとの相関分析

- Human Gate Judgment における NG / 保留ケースと
- 観測された差分の種類・頻度

を横断的に分析することで、
**差分が評価判断に与える影響傾向**を後付けで検証できる。

※ 本仕様は、
この相関を前提として設計されていない点に注意する。

---

### 14.3 Coverage Policy との連携

- 質問カバレッジ
- 条文参照カバレッジ
- 附則・経過措置の扱い

と ObservationResult を突合することで、
**差分が生じやすい条件の整理**に応用できる可能性がある。

---

### Appendix の位置づけ

Appendix は、

- 仕様変更の予告
- 実装予定の宣言

ではなく、
**将来の設計検討における思考ログ**として残す。

---
