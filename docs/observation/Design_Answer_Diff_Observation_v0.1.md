---
title: Design_Answer_Diff_Observation
version: v0.1
status: fixed
project: reiki-rag-converter
doc_type: design
created: 2026-01-17
author: Sumio Nishioka + ChatGPT
related_docs:
  - Qommons_Evaluation_Framework_v0.1.md
  - Design_Execution_Input_Contract_v0.2.md
  - PROJECT_STATUS.md
tags:
  - observation
  - diff
  - answer
  - evaluation-preprocess
---

※ v0.1 は **思想と責務境界の固定**が目的
※ 実装詳細は「含めるが縛らない」

---

## 1. Purpose（目的）

本設計は、HTML版および Markdown版で生成された `answer.md` について、
**その出力差を評価前に体系的に観測・整理すること**を目的とする。

本プロジェクトにおいて `answer.md` は、
生成AIテスト自動化プロジェクト側（gov-llm-e2e-testkit）における
**評価対象そのもの**であり、
HTML / Markdown の違いは「入力表現差」に起因する
**挙動差観測のための条件差**として位置づけられる。

そのため本設計では、以下を明確な前提とする。

- HTML版 / Markdown版の差分を
  **不具合・劣化・品質差として即断しない**
- 差分をもって
  **仕様変更・入力修正・評価基準修正を行わない**
- 差分はあくまで
  **Evaluation Framework に基づく人手評価を行う前段の観測情報**として扱う

本設計が提供するのは、
「どちらが良いか」「どちらが正しいか」という判断ではなく、

- どの質問・どの条例において
- どの種類の差分（構造・情報量・参照表現等）が発生したか
- それが **どの評価軸（Gate）に関係しそうか**

という **評価準備情報の整理**である。

したがって、本設計およびこれに基づく実装は、

- OK / NG / △ の判定を行わない
- 評価軸の解釈・意味づけを変更しない
- Qommons Evaluation Framework の責務を侵食しない

ことを厳守する。

**本設計は「評価（Evaluation）」ではなく、
評価に先立つ「観測（Observation）」であることを明示する。**

---

## 2. Scope & Non-Scope（スコープ定義）

本章では、本設計およびそれに基づく実装が
**何を対象とし、何を明確に対象外とするか**を定義する。
これは、後続フェーズでの責務混入や誤解釈を防ぐための
**境界条件の固定**を目的とする。

---

### 2.1 Scope（やること）

本設計が対象とする範囲は、以下に限定される。

- HTML版および Markdown版で生成された `answer.md` を  
  **条例ID・質問ID単位で対応付けること**
- 対応付けられた `answer.md` ペアについて、  
  以下の観点から **機械的に差分を抽出・整理すること**
  - 回答の構造（見出し・列挙・附則セクション等）
  - 回答の情報量（文字数・段落数・行数等）
  - 条・項・附則といった参照表現の出現状況
- 抽出した差分を、  
  **Qommons Evaluation Framework における Gate 観点と  
  対応付け可能な形式で提示すること**

ここで言う「対応付け可能」とは、  
差分そのものを評価するのではなく、

> 「この差分は、どの Gate 観点に関係しうるか」

を **人手で判断できる状態に整理する**ことを指す。

---

### 2.2 Non-Scope（やらないこと）

本設計および実装は、以下を**明確に行わない**。

- 差分に対して  
  OK / NG / △ といった **評価判定を行うこと**
- 回答内容の正誤、妥当性、網羅性を判断すること
- 文体・語彙・自然さ・分かりやすさといった  
  **表現品質の評価**
- 異なる LLM やモデル間の性能比較
- 生成された `answer.md` 自体を  
  修正・補正・正規化すること

これらはすべて  
**Qommons Evaluation Framework に基づく人手評価の責務**  
もしくは、別フェーズで扱うべき事項であり、  
本設計のスコープ外とする。

---

## 3. Positioning in Evaluation Pipeline（位置づけ）

本設計が評価全体のどこに位置づけられるかを、  
以下のパイプライン図に示す。

```text
Execution Input
  └─ HTML / Markdown Knowledge
        ↓
     RAG Answer Generation
        ↓
  Answer Diff Observation  ← ★本設計
        ↓
  Qommons Evaluation Framework
        ↓
     Human Gate Judgment
```

本設計は、
**RAG によって生成された回答結果（answer.md）を対象としつつ、  
正式な評価フェーズには入らない中間段階**に位置づけられる。

---

### 3.1 Execution Input Contract との関係

HTML版 / Markdown版の違いは、  
Execution Input Contract 上で許容・想定された  
**入力表現差**である。

本設計では、この入力差を：

- 正規化しない
- 吸収しない
- 評価基準側に押し戻さない

という立場を取る。

すなわち、

- HTML / Markdown の差を
  **評価前に歪めることなく**
- RAG の挙動差として
  **そのまま観測・記録する**

ことを目的とする。

そのため、本設計および実装は
**Execution Input Contract を変更・補完・修正しない**。

---

### 3.2 Qommons Evaluation Framework との関係

Qommons Evaluation Framework は、

- 回答結果を人手で読み
- Gate 軸（OK / △ / NG）に基づいて
- 運用上の逸脱を判断する

ための **正式な評価フレームワーク**である。

一方、本設計は：

- 評価を行わない
- 判定を下さない
- 合否を決めない

代わりに、

- どの回答に
- どの種類の差分が発生しているか
- それが **どの Gate 観点に関係しそうか**

を事前に整理することで、
**Evaluation Framework に基づく人手評価を支援する**。

---

### 3.3 観測結果の扱い

本設計によって得られる観測結果は、

- 評価補助情報
- 調査優先度付けのための材料
- 差分傾向の記録

として利用される。

これらの結果は：

- 評価結果そのものではない
- 評価基準を更新する根拠とはならない
- 仕様変更を即時に正当化するものではない

ことを明確にする。

**観測は評価を代替しない。
観測は評価を支援する。**

---

## 4. Relationship to Evaluation Framework

### 4.1 基本方針

本設計は、
本プロジェクトにおいて定義されている
**Evaluation Framework（`Qommons_Evaluation_Framework_v0.1`）**
を前提として成立する。

本設計の目的は、Evaluation Framework に基づく
**人手 Gate 評価を効率化・安定化するための観測情報を提供すること**であり、

- Evaluation Framework の評価軸を拡張しない
- 判定基準（OK / △ / NG）を変更しない
- 評価思想・責務境界を侵食しない

ことを明確な前提とする。

すなわち、本設計は
Evaluation Framework の**前段に位置する補助設計**であり、
評価そのものを代替・自動化するものではない。

本文中の**Evaluation Framework**は
本プロジェクトで定義された
`Qommons_Evaluation_Framework_v0.1` を指し、
特定の外部サービスを意味しない。

---

### 4.2 Gate 軸との対応関係（概念）

本設計で観測される差分は、
Evaluation Framework における Gate 軸と
以下のように **概念的な対応関係**を持つ。

| Gate軸 | 観測される差分の種類 |
| ------ | ---------------- |
| 根拠準拠性 | 条・項・附則参照表現の差 |
| 参照到達性 | 対象条文の出現有無 |
| 構造保持性 | 見出し・列挙・附則構造の差 |
| 過剰補完耐性 | 情報量（文字数・段落数等）の増減 |
| 意図追従性 | 要約率・冗長率の変化 |

本表は**代表的な対応例**を示すものであり、  
すべての差分が**必ずしも当該 Gate 観点に影響することを意味しない**。

ここで示す対応関係は、
**評価判定を自動化するためのものではない**。

あくまで、

> 「どの差分が、どの Gate 観点に関係しそうか」

を人手で判断するための
**整理・誘導情報**として利用される。

本設計および実装は、
これらの Gate 軸に対して
**OK / NG / △ といった判定を行わない**。

---

## 5. Observation Model（観測モデル）

本章では、本設計において
**何を最小単位として観測し、
どのような論理モデルとして扱うか**を定義する。

ここで定義される観測モデルは、
差分検出・結果出力・人手評価への引き渡しにおける
**共通前提**となる。

---

### 5.1 観測単位

本設計における観測の最小単位は、
以下の3要素の組み合わせとする。

- **条例ID**
  観測対象となる条例を一意に識別する識別子。
- **質問ID**
  当該条例に対して投入された質問を識別する識別子。
- **answer.md（HTML版 / Markdown版）**
  同一条例・同一質問に対して、
  HTML版ナレッジおよび Markdown版ナレッジを用いて
  それぞれ生成された回答結果。

これら3要素がそろって初めて、
**「入力表現差に起因する出力差」**を観測可能となる。

---

### 5.2 内部論理モデル（概念）

本設計および実装では、
上記の観測単位を以下の論理モデルとして扱う。

```text
AnswerPair
├─ ordinance_id
├─ question_id
├─ html_answer
└─ md_answer
```

`AnswerPair` は、

- HTML版と Markdown版の回答を
  **常にペアとして扱う**
- どちらか一方のみを
  単独で評価・判断しない

という設計思想を明示するための
**概念モデル**である。

このモデルは、

- 実装言語
- データ構造（クラス / 辞書 / JSON 等）

を拘束するものではなく、
**「常に対応関係を前提に処理する」**という
設計上の不変条件を示すことを目的とする。

---

### 5.3 モデルの不変条件

`AnswerPair` に対して、
以下を不変条件（Invariant）として扱う。

- `ordinance_id` と `question_id` が一致しない
  HTML / Markdown の組み合わせは観測対象としない
- HTML版または Markdown版のいずれかが欠落している場合、
  当該ペアは「差分未観測」として扱う
- 片側のみを基準（正）として
  他方を比較対象（誤）とみなさない

これにより、本設計は：

- 優劣を前提としない
- 正解を内包しない
- 評価判断を混入させない

という前提を
モデルレベルで担保する。

---

## 6. Observation Axes（観測軸）

本章では、`AnswerPair` に対して
**どの観点から差分を観測するか**を定義する。

ここで定義される観測軸は、

- 差分の有無を機械的に検出できること
- 評価判断を内包しないこと
- Evaluation Framework の Gate 軸と
  **概念的に接続可能であること**

を満たす、**最小かつ十分な集合**として選定されている。

---

### 6.1 Structural Diff（構造差）

**定義**
回答文の論理的・形式的な構造に関する差分を観測する。

**観測対象**

- 見出し階層
  - 見出しの有無
  - 見出しレベルの深さ
- 箇条書き構造
  - 列挙の有無
  - 箇条書きと段落の切り替わり
- 附則セクションの有無・粒度
  - 附則が独立セクションとして存在するか
  - 複数の附則・経過措置が分離されているか

**設計上の意図**

構造差は、
**情報の欠落や誤りそのものではなく**、

- 情報の整理単位
- 読み取りやすさ
- 意味的な区切り

が変化した可能性を示す
**観測シグナル**として扱う。

本観測では、
構造が「良いか」「正しいか」は判断しない。

---

### 6.2 Volume Diff（情報量差）

**定義**
回答に含まれる情報量の増減に関する差分を観測する。

**観測対象**

- 文字数
- 行数
- 段落数

**設計上の意図**

HTML版 / Markdown版の差により、

- 要約度が変化した
- 説明が圧縮・展開された
- 冗長さが増減した

といった傾向が現れる可能性がある。

これらは、

- 過剰補完
- 情報落ち
- 意図追従性の変化

といった評価観点に
**関係しうる兆候**であるが、
本設計では **数値差としてのみ記録**する。

---

### 6.3 Reference Diff（参照差）

**定義**
回答中で言及される条例上の参照表現に関する差分を観測する。

**観測対象**

- 条番号（例：「第○条」）
- 項番号（例：「第○項」）
- 附則・経過措置に関する表現

**設計上の意図**

参照差は、

- 到達条文のズレ
- 参照の欠落
- 参照表現の簡略化

といった現象を検知するための
**重要な観測軸**である。

ただし本設計では、

- 参照が正しいか
- 条文解釈が適切か

といった判断は行わず、
**出現有無・表現差の事実のみ**を扱う。

---

### 6.4 観測軸の共通方針

すべての観測軸において、
以下を共通方針とする。

- 差分は「事実」として扱う
- 差分に意味づけをしない
- 差分を評価結果に直結させない

これにより、本設計は
Evaluation Framework による人手評価を
**歪めず、補助するための観測層**として機能する。

---

## 7. Output Specification（出力仕様）

本章では、本設計に基づく観測結果を
**どの形式で、どの粒度で出力するか**を定義する。

出力は以下の2系統に分かれる。

- 機械処理・集計・再利用を目的とした
  **Machine-readable Output**
- 人手レビュー・評価準備を目的とした
  **Human-readable Output**

両者は同一の観測結果から生成され、
**内容の意味は一致するが、用途が異なる**。

---

### 7.1 Machine-readable Output（JSON）

**目的**
差分観測結果を、
後続処理・集計・長期保存に耐える形で記録する。

**出力単位**

- 1レコード = 1 `AnswerPair`
- 条例ID × 質問ID 単位

**含める情報**

- **差分フラグ**
  - 各観測軸ごとに
    「差分が検出されたか否か」を真偽値で保持
- **定量メトリクス**
  - 文字数・行数・段落数などの数値情報
- **対象識別子**
  - 条例ID
  - 質問ID

**出力例（概念）**

```json
{
  "ordinance_id": "k518RG00000022",
  "question_id": "Q8",
  "diff_flags": {
    "structural_diff": true,
    "volume_diff": true,
    "reference_diff": false
  },
  "metrics": {
    "html": {
      "chars": 812,
      "lines": 14,
      "paragraphs": 5
    },
    "markdown": {
      "chars": 524,
      "lines": 9,
      "paragraphs": 3
    }
  }
}
```

**設計上の注意**

- フラグは **判定結果ではない**
- 数値は **解釈を伴わない事実**として保持する
- JSON 構造は
  実装言語・実行環境に依存しない形とする  
- diff_flags は列挙型ではなく辞書である

---

### 7.2 Human-readable Output（Markdown）

**目的**
人手による評価・調査において、
「どこを見るべきか」を素早く把握できるようにする。

**出力単位**

- 条例ID × 質問ID 単位のセクション

**含める情報**

- 当該 `AnswerPair` における差分の要約
- 観測された差分の種類
- 関連しそうな Gate 観点の**示唆**
  （※ 判定は含めない）

**出力例（概念）**

```md
## k518RG00000022 / Q8

- 構造差: あり（附則セクションの粒度が異なる）
- 情報量差: あり（HTML版 > Markdown版）
- 参照差: なし

関連しそうな Gate 観点:
- 構造保持性
- 意図追従性
```

**設計上の注意**

- 「良い／悪い」「正しい／誤り」といった表現を用いない
- Gate 観点は
  **確認候補として列挙するにとどめる**
- 人手レビューを
  **短時間で開始できること**を最優先とする

---

### 7.3 出力の一貫性

Machine-readable Output と
Human-readable Output は、

- 同一の観測結果を元に生成される
- 表現形式は異なるが、
  **意味的な齟齬を持たない**

ことを不変条件とする。

---

## 8. Automation Policy（自動化方針）

本章では、本設計に基づく処理のうち、
**どこまでを自動化し、どこからを人手に委ねるか**を定義する。

本プロジェクトでは、
自動化による効率向上よりも、
**評価思想の破壊や責務混入を防ぐこと**を優先する。

---

### 8.1 自動化の範囲

自動化は、以下に限定される。

- HTML版 / Markdown版 `answer.md` の対応付け
- 観測軸（構造差・情報量差・参照差）に基づく
  **差分の検出**
- 差分結果の
  Machine-readable / Human-readable 出力生成

これらはすべて、

- 事実の抽出
- 状態の整理
- 観測結果の提示

にとどまり、
**意味づけや判断を伴わない処理**である。

---

### 8.2 自動化しないこと

以下は、明確に自動化の対象外とする。

- OK / NG / △ の判定
- Gate 評価結果の確定
- 差分の重要度判断
- 評価基準・設計判断の更新

これらはすべて、

- 文脈依存性が高く
- 運用上の影響が大きく
- 将来の設計変更を正当化しうる

ため、**人手で行うべき判断**として残す。

---

### 8.3 LLM 利用方針

LLM の利用は、以下の条件を満たす場合に限り、
**任意かつ補助的**に認める。

- 差分内容の要約
- 人手レビューを支援する説明文の生成
- 観測結果の読みやすさ向上

ただし、LLM を用いる場合でも：

- 判定ロジックを委ねない
- 評価結果を生成させない
- 「正しい」「誤り」といった断定表現を生成させない

ことを厳守する。

LLM はあくまで
**観測結果を理解しやすくするための補助手段**であり、
評価主体にはならない。

---

### 8.4 方針の固定意図

本自動化方針は、

- 観測と評価の責務境界を守る
- Execution Input Contract の思想を侵害しない
- 将来の仕様変更・評価変更を
  観測結果に引きずらせない

ために設けられている。

**自動化は、判断の代替ではない。
自動化は、判断の準備である。**

---

## 9. Risk & Anti-Patterns（注意点）

本章では、本設計およびそれに基づく運用において
**陥りやすい誤解・誤用・設計逸脱**を明示し、
それらを回避するための注意点を整理する。

本設計は、
差分を「観測」するためのものであり、
**判断や評価を行うためのものではない**。
この前提が崩れた場合、本設計は容易に誤用される。

---

### 9.1 差分＝不具合と誤認しない

HTML版 / Markdown版の `answer.md` に差分が存在することは、
**異常・欠陥・劣化を意味しない**。

差分は以下のいずれかである可能性を常に含む。

- 入力表現差に起因する自然な揺れ
- 要約・圧縮・構造整理の違い
- RAG の探索経路差による表出の違い

本設計では、
差分を **事実として記録すること**にのみ責任を持ち、
それが問題か否かの判断は
Evaluation Framework に基づく人手評価に委ねる。

---

### 9.2 評価ロジックを混入させない

差分観測の結果に対して、

- 良い / 悪い
- 正しい / 誤り
- 問題あり / 問題なし

といった **評価的な意味づけ**を
自動処理・出力・コメントに混入させてはならない。

特に以下は、
設計上の **アンチパターン**とする。

- 差分フラグをもとに
  OK / NG を自動判定する
- 特定の差分を
  「修正対象」「不具合候補」と断定する
- 観測結果を根拠に
  入力仕様・評価仕様を即時に変更する

これらはすべて、
**観測と評価の責務境界を破壊する行為**である。

---

### 9.3 diff 全文貼りによるレビュー破綻を避ける

HTML版 / Markdown版の全文 diff を
そのまま人手レビューに提示することは、
以下の理由から避けるべきである。

- 情報量が過剰になり、
  重要な差分が埋もれる
- レビューコストが急激に増大する
- 「読むこと」自体が目的化し、
  評価の一貫性が失われる

本設計では、

- 差分の **要約**
- 差分の **種類**
- 関係しそうな Gate 観点の **示唆**

のみを提示し、
**全文確認は必要な場合に限定する**ことを前提とする。

---

### 9.4 本章の位置づけ

本章で列挙した注意点は、

- 実装レビュー時
- 運用フロー設計時
- 将来の拡張・自動化検討時

において、
「この設計はどこまでやってよいのか」を
判断するための **ガードレール**として機能する。

---

了解。
では **第10章（Versioning Policy）** を、
**将来の更新判断にそのまま使える形**で書き起こします。

---

## 10. Versioning Policy

本章では、本設計書およびそれに基づく観測仕様の
**バージョニング方針**を定義する。

本設計は、
実装と並行して運用されることを前提とするが、
評価思想や責務境界を不用意に揺らさないため、
**段階的かつ慎重なバージョン管理**を行う。

---

### v0.1（初期版）

**目的**

- 観測と評価の責務境界を明確に固定する
- 本設計の思想・前提・位置づけを文書として確定する

**特徴**

- 観測軸は最小構成
- 実装詳細には過度に踏み込まない
- 運用上の試行錯誤を許容する

v0.1 は、
**設計思想の確立を最優先**とした版であり、
数値閾値や自動化範囲の厳密化は行わない。

---

### v0.2（拡張版）

**目的**

- 観測対象の拡張に対応する

**想定される拡張内容**

- 表・別表を含む回答の差分観測
- 構造差の粒度調整
- 追加メトリクスの導入

**注意点**

- Evaluation Framework の評価軸を変更しない
- v0.1 で固定した責務境界を維持する

v0.2 は、
**運用経験に基づく観測能力の拡張**を目的とする。

---

### v1.0（凍結版）

**目的**

- 観測仕様を長期運用可能な形で凍結する

**到達条件（目安）**

- 複数条例・複数質問での継続運用実績がある
- 観測結果が評価作業の前提として安定している
- 仕様変更が例外的になった

v1.0 では、

- 観測軸
- 出力形式
- 自動化範囲

を原則として固定し、
**長期的な比較・回帰観測に耐える設計**とする。

---

### バージョン更新時の原則

- 小さな改善でも
  **Version を明示して記録する**
- 思想・責務境界に影響する変更は
  必ず Minor / Major として扱う
- CHANGELOG に
  観測仕様の変更理由を残す

---

## 11. Appendix（将来拡張メモ）

本章では、本設計のスコープ外ではあるが、
将来的に検討・拡張されうる論点を
**備忘および設計上の視界として整理**する。

以下に挙げる内容は、
現時点では **実装・運用の前提条件ではない**。

---

### 11.1 Playwright 実行結果との突合

将来的には、
Playwright による UI 操作・実行ログと
本設計による差分観測結果を突合することで、

- 回答生成フロー上の挙動差
- UI 状態遷移と出力差分の関係
- タイムアウト・再試行などの影響

といった、
**生成過程と出力結果の相関**を分析できる可能性がある。

ただしこれは、

- 実行環境依存性が高い
- 観測粒度が異なる

ため、
本設計（answer.md 差分観測）とは
明確にレイヤーを分離した上で扱う必要がある。

---

### 11.2 Gate NG ケースとの相関分析

Evaluation Framework に基づく人手評価において
Gate NG と判定されたケースについて、

- 事前にどのような差分が観測されていたか
- 特定の観測軸と NG 判定に傾向があるか

を **事後的に分析**することで、

- 観測軸の妥当性検証
- 観測結果の活用可能性検討

を行う余地がある。

ただし、この分析結果は：

- 自動判定ロジックの根拠としない
- 観測結果の意味づけを固定しない

ことを前提とする。

---

### 11.3 Coverage Policy との横断分析

Coverage Policy に基づく質問設計と、
本設計による差分観測結果を横断的に見ることで、

- 特定の質問タイプで差分が出やすいか
- 条・項・附則の扱いによる傾向差
- 観測負荷の高い質問群の特定

といった、
**設計上の知見を得られる可能性**がある。

これらは、

- 質問設計の改善検討
- 評価作業の効率化

に資する可能性があるが、
本設計の直接的な目的には含めない。

---

### 11.4 本章の位置づけ

本章は、

- 将来の拡張余地を閉ざさない
- 現時点で「やらない理由」を明確にする
- 後続検討の出発点を残す

ための **メモ的章**である。

本設計の正当性や完成度は、
本章に記載された内容を
**実装しなくても損なわれない**。

---
