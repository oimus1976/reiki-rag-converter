name: E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [ "3.10", "3.11", "3.12" ]

    env:
      SKIP_E2E: true   # 実HTMLのE2Eを常時skipする
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      # ---------------------------------------------------------
      # 追加：smoke test が存在することを保証する（必須ステップ）
      # ---------------------------------------------------------
      - name: Ensure smoke test exists
        run: |
          if [ ! -f "tests/test_smoketest.py" ]; then
            echo "ERROR: tests/test_smoketest.py が存在しません。CI 安定稼働のため必須です。"
            exit 1
          fi
      # ---------------------------------------------------------

      # ---------------------------------------------------------
      # Step 1: synthetic generator v0.2 の動作確認
      # ---------------------------------------------------------
      - name: Generate synthetic HTML (v0.2)
        run: |
          python src/synthetic_generator_v0.2.py \
            --meta-dir synthetic_html_meta/v0.2 \
            --output-dir synthetic_html
    
      # ---------------------------------------------------------
      # Step 2: validate の実行
      # ---------------------------------------------------------
      - name: Run validate
        run: |
          python src/validate_reiki_structure_v0.5.3.py \
            --source synthetic_html \
            --output logs_validate_ci

      # ---------------------------------------------------------
      # Step 3: convert の実行
      # ---------------------------------------------------------
      - name: Run convert
        run: |
          python src/convert_reiki_v2.7.py \
            --source synthetic_html \
            --output output_md_ci

      # ---------------------------------------------------------
      # Step 4: Golden diff（converted_at は比較対象から除外）
      # ---------------------------------------------------------
      - name: Golden diff (P11–P15)
        run: |
          mkdir -p tmp_golden tmp_output

          for f in golden_md/v1/*.txt; do
            base=$(basename "$f")
            if [ ! -f "output_md_ci/$base" ]; then
              echo "ERROR: Missing output file: output_md_ci/$base"
              exit 1
            fi

            # 比較用に converted_at 行を除外したファイルを作成
            grep -v '^converted_at:' "$f" > "tmp_golden/$base"
            grep -v '^converted_at:' "output_md_ci/$base" > "tmp_output/$base"

            # diff 実行（差分があればFAIL）
            diff -u "tmp_golden/$base" "tmp_output/$base" || {
              echo "ERROR: Golden diff failed for $base"
              exit 1
            }
          done

          echo "Golden diff passed for all files."



      - name: Run pytest
        run: |
          python -m pytest -q

